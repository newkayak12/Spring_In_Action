# 16. 스프링 부트 액추에이터 사용하기

스프링 부트 액추에이터는 스프링 부터 애플리케이션의 모니터링이나 메트릭(metric)과 같은 기능을 HTTP와 JMX 엔드포인트(endpoint)를 통해서
제공한다.


## 16.1 액추에이터 개요
기계 장치에서 액추에이터는 메커니즘을 제어하고 작동시키는 부품이다. 스프링 부트 애플리케이션에서는 스프링 부트 액추에이터가 그와 같은 역할을 수행한다.
즉, 실행 중인 애플리케이션의 내부를 볼 수 있게 하고, 어느 정도까지는 애플리케이션의 작동 방법을 제어할 수 있게 한다.
액추에이터가 노출하는 엔드포인트를 사요하면 실행 중인 스프링 부트 애플리케이션의 내부 상태에 관한 것을 알 수 있다. 예를 들면

- 애플리케이션 환경에서 사용할 수 있는 구성 속성들
- 애플리케이션에 포함된 다양한 패키지의 로깅 레벨
- 애플리케이션이 사용 중인 메모리
- 지정된 엔드포인트가 받은 요청 횟수
- 애플리케이션의 건강 상태 정보

```xml
<dependency>
    <grouopId>org.springframework.boot</grouopId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

이처럼 액추에이터가 스타터 프로젝트 빌드의 일부가 되면 여러 가지 액추에이터 엔드포인트를 사용할 수 있다.

|   HTTP METHOD   |      PATH       |                                   DESCRIPTION                                   | 기본 활성 여부 |
|:---------------:|:---------------:|:-------------------------------------------------------------------------------:|:-------:|
|       GET       |  /auditevents   |                            호출된 감사(audit) 이벤트 리포트를 생성                            |    N    |
|       GET       |     /beans      |                          스프링 애플리케이션 컨텍스트의 모든 빈을 알려준다.                           |    N    |
|       GET       |   /conditions   |                         성공 또는 실패했던 자동-구성 조건의 내역을 생성한다.                          |    N    |
|       GET       |  /configprops   |                            모든 구성 속성들은 현재 값과 같이 알려준다.                            |    N    |
| GET,<br/>POST,<br/>DELETE |      /env       |                 스프링 애플리케이션에 사용할 수 있는 모든 속성 근원과 이 근원들의 속성을 알려준다.                 |    N    |
|       GET       | /env/{toMatch}  |                               특정 환경 속성의 값을 알려준다.                                |    N    |
|       GET       |     /health     |                             애플리케이션의 건강 상태 정보를 반환한다.                             |    Y    |
|       GET       |    /heapdump    |                                 힙의 덤프를 다운로드 한다.                                 |    N    |
|       GET       |   /httptrace    |                         가장 최근의 100개 요청에 대한 추적 기록을 생성한다.                         |    N    |
|       GET       |      /info      |                          개발자가 정의한 애플리케이션에 관한 정보를 반환한다.                          |    Y    |
|       GET       |    /loggers     |                    애플리케이션의 패키지 리스트(각 패키지의 로깅 레벨이 포함된)를 생성한다.                    |    N    |
|    GET,POST     | /loggers/{name} | 지정된 로거의 로깅 레벨(구성된 로깅 레벨과 유효 로깅 레벨 모두)을 반환한다. 유효 로깅 레벨은 HTTP POST 요청으로 설정될 수 있다. |    N    |
|       GET       |    /mappings    |                   모든 HTTP 매핑과 이 매핑들을 처리하는 핸들러 메소드들의 내역을 제공한다.                   |    N    |
|       GET       |    /metrics     |                                모든 메트릭 리스트를 반환한다.                                |    N    |
|       GET       | /metrics/{name} |                                지정된 메트릭의 값을 반환한다.                                |    N    |
|       GET       | /scheduledtasks |                             스케쥴링된 모든 태스크의 내역을 제공한다.                             |    N    |
|       GET       |   /threaddump   |                            모든 애플리케이션 쓰레드의 내역을 반환한다.                             |    N    |

## 16.1.1 엑추에이터의 기본 경로 구성하기
위 표의 경로 앞에는 기본적으로  '/actuator'가 붙는다. 예를 들어, 액추에이터로부터 애플리케이션 건강 상태 정보를 가져오고 싶을 때는 /actuator/health에 GET 요청을 하면 된다.
만약 `/actuator`를 바꾸고 싶다면
```yaml
management:
  endpoints:
    web:
      base-path: /management
```
이러면 `/management/health`로 GET 요청해야 한다.

## 16.1.2 액추에이터 엔드포인트의 활성화와 비활성화
대부분의 액추에이터 엔드포인트는 민감한 정보를 제공하므로 보안 처리가 되어야 하기 때문에 default가 'N'이다. 물론 스프링 시큐리티로 액추에이터 보안 처리를 할 수 있다.
여튼 보안처리가 없고, 민감한 정보를 제공하므로 기본 값은 꺼져 있음이다.

엔드포인트의 노출 여부를 제어할 때는 ```management.endpoints.web.exposure.include```와 ```management.endpoints.web.exposure.include```
를 사용하면 노출을 원하는 엔드포인트를 지정할 수 있다.

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health, info, beans, conditions
```
또한 include 속성은 와일드카드(*)도 사용할 수 있다. 이는 include로 `*`를 놓고 exclude에서 노출하지 않고 싶은 것만 제거할 수 있음을 의미한다.

## 16.2 액추에이터 엔드포인트 소비하기
액추에이터는 실행 중인 애플리케이션의 흥미롭고 유용한 정보를 HTTP 엔드포인트를 통해서 제공한다. 그리고 HTTP 엔드포인트이므로 다른 REST API 처럼 브라우저 기반 
혹은 terminal에서 curl로도 소비할 수 있다.

엑추에이터가 제공하는 엔드포인트에 어떤 것이 있는지 알아보기 위해서 액추에이터의 기본 경로에 대해서 GET을 하면 HATEOAS 링크를 응답으로 받을 수 있다.

## 16.2.1 애플리케이션 기본 정보 가져오기

### 애플리케이션에 관한 정보 요구하기
실행 중인 애플리케이션에 대한 정보를 얻으려면 /info 엔드포인트에 요구하면 된다. 주로
```yaml
info:
  contact:
    email: ~
    phone: ~
```
과 같은 정보가 info에 담겨서 출력된다.

### 애플리케이션 건강 상태 살펴보기
/heath 엔드포인트에 HTTP GET 요청을 하면 건강 상태를 갖는 간단한 JSON을 응답받는다. 
`{"status":"UP"}`과 같이 말이다.
UP는 하나 이상의 건강 상태를 종합한 지표이다. 건강 지표는 애플리케이션이 상호 작용하는 외부 시스템(DB, 메시지 브로커, Eureka, configServer)의 건강 상태를
나타낸다.

- UP: 외부 시스템이 작동 중이고 접근 가능
- DOWN: 외부 시스템이 장도하지 않거나 접근 불가
- UNKNOWN: 외부 시스템 상태를 모름
- OUT_OF_SERVICE: 외부 시스템에 접근할 수 있지만 현재는 사용 불가

모든 건강 지표의 건강 상태는 아래의 규칙에 따라 애플리케이션의 전체 건강 상태로 종합된다.

- 모든 건강 지표가 UP이면 애플리케이션의 건강 상태도 UP
- 하나 이상의 건강 지표가 DOWN이면 건강 상태고 DOWN
- 하나 이상의 건강 지표가 OUT_OF_SERVICE이면 애플리케이션 건강 상태도 OUT_OF_SERVICE
- UNKNOWN은 무시되며 애플리케이션 종합 건강 상태에 고려되지 않는다.

```yaml
management:
  endpoint:
    health:
      show-details: always
```
로 상세 건강 지표를 볼 수 있다. 해당 속성의 기본값은 never이다. 또한   `when-authorized`로 설정하면 요청하는 클라이언트가 완벽하게 인가된 경우에 한해서 상세 내역을
보여준다.

자동 구성에서는 애플리케이션과 관련된 건강 지표만 /heath에 노출된다. 그러나 건강 지표에 아래의 항목을 추가하여 건강 지표를 제공 받을 수도 있다.
- 카산드라
- 구성 서버
- Couchbase
- 유레카
- Hystrix
- JDBC 데이터 소스
- Elasticsearch
- InfluxDB
- JMS 메시지 브로커
- LDAP
- 이메일 서버
- Neo4j
- RabbitMQ
- Redis
- Solr

또한 서드 파티 라이브러리들도 건강 지표를 제공할 수 있다.


## 16.2.2 구성 상세 정보 보기
애플리케이션에 관한 일반 정보를 받는 것은 기본적으로 필요하지만, 이보다 더 유용한 정보를 알아야 할 필요가 있다. 예를 들면 애플리케이션이 어떻게 구성됐는지, 애플리케이션
컨텍스트에 어떤 빈이 있는지, 어떤 자동-구성이 실패/성공인지 어떤 환경 속성들을 애플리케이션에 사용할 수 있는지, HTTP 요청이 어떻게 컨트롤러와 연결되는지, 하나 이상의 
패키지나 클래스에 어떤 로깅 레벨이 설정됐는지 등이다.

이런 것들은 액추에이터의 /bean, /conditions, /env, /configprops, /mappings, /loggers 엔드포인트로 알 수 있다. /env, /loggers 같은 엔드포인드의
경우는 실행 중인 애플리케이션 구성을 실시간으로 조정할 수 있다.

### Bean 연결 정보 얻기
스프링 애플리케이션 컨텍스트를 살펴보는 데 가장 중요한 엔드포인트가 /beans 엔드포인트다. 이 엔드포인트는 애플리케이션 컨텍스트의 모든 빈을 나타내는 JSON을 반환한다.
응답의 최상위는 context 이며, 이는 애플리케이션에 있는 각 스프링 애플리케이션 컨텍스트의 하위 요소 하나를 포함한다. 그리고 각 스프링 애플리케이션 컨텍스트에는 bean 요소가 있으며,
이는 해당 애플리케이션 컨텍스트에 있는 모든 빈의 상세 정보를 갖는다.

### 자동-구성 내역 알아보기
자동-구성에 대해서 궁금할 수 있다. 왜 자동-구성이 됐는지, 또는 자동-구성이 됐을 것 같은데 왜 안됐는지 등이다. 이런 경우에  /conditions 엔드포인트를 GET 하여
알아볼 수 있다.

/conditions 요청에 대한 결과는 세 부분으로 나눈다. ```PositiveMatches (성공한 조건부 구성)```, ```NegativeMatches(실패한 조건부 구성)```, ```UnconditionalClasses(조건 없는 클래스)```
이다. positiveMatches는 자동-구성이 성공했음을, 여기서 message에 ```@ConditionalOnMissingBean```이 있다면 빈이 구성되지 않았으면 구성되게 한다.
neagetiveMatches는 자동-구성이 실패한 것을 의미한다. 마지막으로 unconditionalClasses는 조건 없이 구성됨을 의미한다. 이는 스프링 부트 작동에 기본이 되는 것이므로
구성 속성에 관련된 구성은 조건없이 자동-구성되기 때문이다.


### 환경 속성과 구성 속성 알아보기
애플리케이션의 빈들이 어떻게 연결되어 있는지 아는 것에 추가하여 어떤 환경 속성들이 사용 가능하고 어떤 구성 속성들이 각 빈에 주입되었는지 파악하는 것도 중요하다.
/env 엔드포인트에 GET을 하면 스프링 애플리케이션에 적용 중인 모든 속성 근원의 속성들을 포함하는 응답을 받을 수 있다.

주목할 만한 몇 가지를 보자면 activeProfiles, propertySource 등이 있다.
/env는 단순히 속성을 보는 것만이 아니라 속성을 설정할 수도 있다. 즉 key-value 쌍으로 이뤄진 JSON 문서를 담은 POST를 보내면 실행 중인 애플리케이션의 속성을 
설정할 수 있다.

```shell
 curl http://localhost:8080/actuator/env \
-d'{"name:"hello", "value":"bye"}'\
-H "Content-type: application/json"
```
필요 없는 속성은 DELETE 요청으로 삭제할 수 있다. 이러한 변경은 일시적이며 재시작시 적용되지 않는다.

### HTTP 요청 - 매핑 내역 보기






